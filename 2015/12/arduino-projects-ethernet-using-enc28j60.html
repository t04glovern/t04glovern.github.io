<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>TwoFactor Assimilation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="http://t04glovern.github.io/js/jquery.min.js"></script>
  <script src="http://t04glovern.github.io/js/bootstrap.min.js"></script>
  <script src="http://t04glovern.github.io/js/header.js"></script>
  <link href="http://t04glovern.github.io/css/bootstrap.min.css" rel="stylesheet">
  <link href="http://t04glovern.github.io/css/theme.css" rel="stylesheet">
  <link href="http://t04glovern.github.io/css/syntax.css" rel="stylesheet">
  <link href="http://t04glovern.github.io/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Ubuntu+Mono&subset=latin">

</head>

<body>

  
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-71336829-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  


  <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://t04glovern.github.io/">TwoFactor Assimilation</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="http://t04glovern.github.io/">/home</a></li>
          <li><a href="http://t04glovern.github.io/archive.html">/archive</a></li>
          <li><a href="http://t04glovern.github.io/tags.html">/tags</a></li>
          <li><a href="http://t04glovern.github.io/about.html">/about</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">
              <h1><a href="http://t04glovern.github.io/2015/12/arduino-projects-ethernet-using-enc28j60">Arduino Projects - Ethernet using a ENC28J60 Ethernet Controller</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>30 Dec 2015</time>
                </div>
                <ul>
                  
                    <li><a href="http://t04glovern.github.io/tag/arduino">arduino</a></li>
                  
                    <li><a href="http://t04glovern.github.io/tag/ethernet">ethernet</a></li>
                  
                </ul>
              </div>
              <div class="post-content">
                <h2 id="introduction">Introduction</h2>

<p>I’ve been putting off learning about interfacing for a while now. It isn’t because I don’t want to learn it though; In fact it’s probably the part of embedded systems that I was looking most forward to. No; the reason I’ve been putting it off is purely due to the difficulty I’ve had trying to find a good, concise explanation of how it all works. I’m not content just loading in the interfacing libraries and accepting that as complete; I would really like to understand what is actually happening on each pin that I’m interfacing with and maybe even understand what the driver is doing.</p>

<h2 id="the-module">The Module</h2>

<p>So lets get started! The module I purchased to work with is a <code class="highlighter-rouge">Duinotech</code> board sporting a <code class="highlighter-rouge">HanRun HR911105A RJ45 connector</code> and the <code class="highlighter-rouge">ENC28J60 Ethernet controller</code>.</p>

<p><img src="http://t04glovern.github.io/images/posts/arduino-ethernet-board.jpg" alt="Ethernet Board" /></p>

<p>The first thing I did was look up the datasheet for the <a href="http://ww1.microchip.com/downloads/en/DeviceDoc/39662e.pdf">ENC28J60 Ethernet controller</a>. I was looking for detailed information on what each of the Ten interface pins on the board did and was happy to find that almost all the information I needed was available in the document provided.</p>

<p>Some of the key features the controller offers that I’m interested in are:</p>

<ol>
  <li>
    <p><code class="highlighter-rouge">Fully Compatible with 10/100/1000Base-T Networks</code> - The interface can provide full gigabit speeds.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">Supports Full and Half-Duplex modes</code> - Bi-directional simultaneous communication can occur on the same port, though I don’t think the Arduino won’t be-able to utilize this due to its single core/one operation at a time limitation.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">SPI Interface with Clock Speeds up to 20 MHz</code> - SPI (Serial Peripheral Interface) will be the main way I communicate with the module. I already know there’s a very extensive <a href="https://www.arduino.cc/en/Reference/SPI">SPI library</a> available that I can learn with.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">8-Kbyte Transmit/Receive Packet Dual Port SRAM</code> - Allows for latching (in SRAM // Static random-access memory) and queuing of packets and data when up to 8-Kbytes. Again, I don’t think this will be relevant to me but it’s still nice to know about.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">Supports Unicast, Multicast and Broadcast Packets</code> - Self explanatory and expected on most interfaces these days.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">WOL or Magic Packet</code> - Wake on LAN, another neat feature I’d love to explore on the board.</p>
  </li>
</ol>

<h2 id="pin-description">Pin Description</h2>

<p>Below is the schematic provided for the <code class="highlighter-rouge">ENC28J60 Ethernet controller</code>. There are only a couple pins that we have direct access to via the Pin headers, I’ll try to explain as best I can what each of these pins are and what they do.</p>

<p><img src="http://t04glovern.github.io/images/posts/arduino-controller-schem.png" alt="Ethernet Controller Schematic" /></p>

<ol>
  <li><code class="highlighter-rouge">CLKOUT</code> - The Programmable clock output pin is provided for use as the host controller clock or as a clock source for other devices in the system.
    <ul>
      <li>Has an internal <code class="highlighter-rouge">Prescaler</code> which can divide the output by 1, 2, 3, 4 or 8. A <code class="highlighter-rouge">Prescaler</code> is used to reduce a high frequency electrical signal to a lower frequency by integer division.</li>
    </ul>
  </li>
  <li>
    <p><code class="highlighter-rouge">INT</code> - Interrupt output pin signals the occurrence of an interrupt event to the host controller.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">WOL</code> - Wake on Lan pin which can be used to push a magic packet through to the Ethernet interface connected. There’s some interesting examples of this <a href="http://playground.arduino.cc/Main/ArduinoWaker">here</a>.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">SO</code> - Also defined as <code class="highlighter-rouge">MISO (Master In Slave Out)</code> and is used as the Slave line for sending data to the master. The master in this case is normally the Arduino or microcontroller.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">SI</code> - Also defined as <code class="highlighter-rouge">MOSI (Master Out Slave In)</code> and is used as the Master line for sending data to the peripherals.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">SCK</code> - The Serial clock which synchronizes the data transmission generated by the master.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">CS</code> - Chip select the input pin for the SPI interface. It is held low while any operation is performed and returned high when finished.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">RESET</code> - Active low device that resets the input.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">VCC</code> - 3.3V supply input.</p>
  </li>
  <li><code class="highlighter-rouge">GND</code> - Grounding pin.</li>
</ol>

<p>If you’re interested in the full block diagram for the controller, it can be seen below. Take note of the various pin labels we just discussed and use them to work out how the system all comes together.</p>

<p><img src="http://t04glovern.github.io/images/posts/arduino-controller-block-diagram.png" alt="Controller Block Diagram" /></p>

<h2 id="serial-peripheral-interface-spi">Serial Peripheral Interface (SPI)</h2>

<p>Commands and data are sent to the device via the <code class="highlighter-rouge">SI pin</code>, with data being clocked in on the rising edge of <code class="highlighter-rouge">SCK</code>. Data is driven out on the <code class="highlighter-rouge">SO line</code> on the falling edge of <code class="highlighter-rouge">SCK</code>. The <code class="highlighter-rouge">CS pin</code> must be held low while any operation is performed and returned high when finished.</p>

<p>Below is a timeline displaying the Pin states for both input and output.</p>

<p><img src="http://t04glovern.github.io/images/posts/arduino-controller-input-output.png" alt="Input Output" /></p>

<p>These interfaces are mapped to the following ports on the Arduino Uno. You can find the correct pins for other boards under Connections <a href="https://www.arduino.cc/en/Reference/SPI">here</a>. Note that the ENC28J60 controller uses a different pin for CS than the normal pin 10 (SS).</p>

<ol>
  <li>
    <p><code class="highlighter-rouge">SI</code> Pin -&gt; Digital <code class="highlighter-rouge">Pin 11</code> OR <code class="highlighter-rouge">ICSP-4</code></p>
  </li>
  <li>
    <p><code class="highlighter-rouge">SO</code> Pin -&gt; Digital <code class="highlighter-rouge">Pin 12</code> OR <code class="highlighter-rouge">ICSP-1</code></p>
  </li>
  <li>
    <p><code class="highlighter-rouge">SCK</code> Pin -&gt; Digital <code class="highlighter-rouge">Pin 13</code> OR <code class="highlighter-rouge">ICSP-3</code></p>
  </li>
  <li>
    <p><code class="highlighter-rouge">CS</code> Pin -&gt; Digital <code class="highlighter-rouge">Pin 8</code></p>
  </li>
</ol>

<p><code class="highlighter-rouge">NOTE</code> You can also use the Reset, Ground and 3.3V pins on the ICSP interface. Else just use the normal pins. You can safely ignore the <code class="highlighter-rouge">RESET pin</code> for most examples.</p>

<p><img src="http://t04glovern.github.io/images/posts/arduino-controller-icsp.png" alt="ICSP" /></p>

<h2 id="ethercard-libraries--examples">Ethercard Libraries + Examples</h2>

<p>In order to get our device communicating we’ll need to use a library called <code class="highlighter-rouge">Ethercard</code>. It can be downloaded from here:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="nl">https:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">jcw</span><span class="o">/</span><span class="n">ethercard</span></code></pre></figure>

<p>Once you’ve downloaded the zip, place the contents in your Arduino <code class="highlighter-rouge">libraries</code> folder. The contents of the <code class="highlighter-rouge">ethercard</code> folder comes with a couple examples that we’ll be using to first confirm that our interfacing is correct.</p>

<p>Go ahead and open up the <code class="highlighter-rouge">testDHCP sketch</code> under examples and upload the code to your Arduino. Connect a networked Ethernet cable to your Ethernet module and fire up the serial monitor. You will also need to set the <code class="highlighter-rouge">baud rate to 57600</code> (as specified in the code).</p>

<p>If all went well you should receive the following serial output indicating that you’ve successfully been assigned a DHCP address (your IP values will vary obviously).</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="p">[</span><span class="n">testDHCP</span><span class="p">]</span>
<span class="n">MAC</span><span class="o">:</span> <span class="mi">74</span><span class="o">:</span><span class="mi">69</span><span class="o">:</span><span class="mi">69</span><span class="o">:</span><span class="mi">2</span><span class="n">D</span><span class="o">:</span><span class="mi">30</span><span class="o">:</span><span class="mi">31</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">DHCP</span>
<span class="n">MyIP</span><span class="o">:</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">188</span><span class="p">.</span><span class="mi">53</span>
<span class="n">Netmask</span><span class="o">:</span> <span class="mi">255</span><span class="p">.</span><span class="mi">255</span><span class="p">.</span><span class="mi">255</span><span class="p">.</span><span class="mi">0</span>
<span class="n">GW</span> <span class="n">IP</span><span class="o">:</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">188</span><span class="p">.</span><span class="mi">254</span>
<span class="n">DNS</span> <span class="n">IP</span><span class="o">:</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">188</span><span class="p">.</span><span class="mi">254</span></code></pre></figure>

<p>Yay! We got it working. That’s a really simple example though, and we still don’t really know how it’s working. Next we’ll take a look at the code and try to build our own code from scratch.</p>

<h2 id="build-a-webserver">Build a Webserver</h2>

<p>Lets open a new project and begin. Start by adding the appropriate code to include the EtherCard library:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;EtherCard.h&gt;</span></code></pre></figure>

<p>Next we’ll setup a place where we can specify static IP information. We’ll do that by creating and populating the following byte arrays with relevant IP network information</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// Ethernet interface ip address
</span><span class="k">static</span> <span class="n">byte</span> <span class="n">myip</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">192</span><span class="p">,</span><span class="mi">168</span><span class="p">,</span><span class="mi">188</span><span class="p">,</span><span class="mi">200</span> <span class="p">};</span>
<span class="c1">// Gateway ip address
</span><span class="k">static</span> <span class="n">byte</span> <span class="n">gwip</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">192</span><span class="p">,</span><span class="mi">168</span><span class="p">,</span><span class="mi">188</span><span class="p">,</span><span class="mi">254</span> <span class="p">};</span>
<span class="c1">// DNS ip address
</span><span class="k">static</span> <span class="n">byte</span> <span class="n">dnsip</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">192</span><span class="p">,</span><span class="mi">168</span><span class="p">,</span><span class="mi">188</span><span class="p">,</span><span class="mi">254</span> <span class="p">};</span>
<span class="c1">// Subnet mask
</span><span class="k">static</span> <span class="n">byte</span> <span class="n">mask</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span> <span class="p">};</span></code></pre></figure>

<p>Add a another byte array to store the mac address of the interface. You can either make up one yourself or obtain the interfaces actual address from the board itself. If you can’t be bothered with either of these things feel free to use mine.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// Ethernet mac address - must be unique on your network
</span><span class="k">static</span> <span class="n">byte</span> <span class="n">mymac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x74</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="mh">0x2D</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="mh">0x31</span> <span class="p">};</span></code></pre></figure>

<p>I would also recommend adding the following line to specify the <code class="highlighter-rouge">TCP/IP buffer size</code>. We will be using this later during the interface initialization.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// TCP/IP send and receive buffer
</span><span class="n">byte</span> <span class="n">Ethernet</span><span class="o">::</span><span class="n">buffer</span><span class="p">[</span><span class="mi">500</span><span class="p">];</span></code></pre></figure>

<p>Now lets get started on the <code class="highlighter-rouge">setup()</code> code. We’ll start by opening up a serial connection for debugging with the baud rate of <code class="highlighter-rouge">57600</code></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Open a serial connection for debugging
</span>  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">57600</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[Debugger]"</span><span class="p">);</span></code></pre></figure>

<p>Now we need to initialize the Ethernet interface using the <code class="highlighter-rouge">ether.begin()</code> function. If we have a look at the functions definition in the <code class="highlighter-rouge">EtherCard.h</code> file we can see what values it accepts.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">    <span class="cm">/**   @brief  Initialize the network interface
    *     @param  size Size of data buffer
    *     @param  macaddr Hardware address to assign to the network interface (6 bytes)
    *     @param  csPin Arduino pin number connected to chip select. Default = 8
    *     @return &lt;i&gt;uint8_t&lt;/i&gt; Firmware version or zero on failure.
    */</span>
    <span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">begin</span> <span class="p">(</span><span class="k">const</span> <span class="kt">uint16_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">macaddr</span><span class="p">,</span>
                          <span class="kt">uint8_t</span> <span class="n">csPin</span> <span class="o">=</span><span class="mi">8</span><span class="p">);</span></code></pre></figure>

<p>We can use the information above to construct the ether.begin() function using the Ethernet buffer size and our Ethernet mac address. We also want to wrap this initialization in an <code class="highlighter-rouge">if statement</code> to confirm the interface is constructed correctly. Use the following syntax to get that done:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// Initialize the Ethernet interface
</span><span class="k">if</span> <span class="p">(</span><span class="n">ether</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="k">sizeof</span> <span class="n">Ethernet</span><span class="o">::</span><span class="n">buffer</span><span class="p">,</span> <span class="n">mymac</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span> <span class="s">"Failed to access Ethernet controller"</span><span class="p">);</span></code></pre></figure>

<p>Next we need to setup the interface with either DHCP or the static values we declared earlier on. You can choose to do either by implementing one of the following solutions:</p>

<p><code class="highlighter-rouge">DHCP</code> implementation</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">ether</span><span class="p">.</span><span class="n">dhcpSetup</span><span class="p">()</span></code></pre></figure>

<p><code class="highlighter-rouge">Static</code> implementation is defined in <code class="highlighter-rouge">EtherCard.h</code></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cm">/**   @brief  Configure network interface with static IP
*     @param  my_ip IP address (4 bytes). 0 for no change.
*     @param  gw_ip Gateway address (4 bytes). 0 for no change. Default = 0
*     @param  dns_ip DNS address (4 bytes). 0 for no change. Default = 0
*     @param  mask Subnet mask (4 bytes). 0 for no change. Default = 0
*     @return &lt;i&gt;bool&lt;/i&gt; Returns true on success - actually always true
*/</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">staticSetup</span> <span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">my_ip</span><span class="p">,</span>
                         <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">gw_ip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">dns_ip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p>And therefore can be implemented as follows:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// Setup IP statically
</span><span class="n">ether</span><span class="p">.</span><span class="n">staticSetup</span><span class="p">(</span><span class="n">myip</span><span class="p">,</span> <span class="n">gwip</span><span class="p">,</span> <span class="n">dnsip</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span></code></pre></figure>

<p>At this point, we should have our interface setup. Just to make sure lets write out the IP values to serial:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// Print IP information out to serial line
</span><span class="n">ether</span><span class="p">.</span><span class="n">printIp</span><span class="p">(</span><span class="s">"IP:  "</span><span class="p">,</span> <span class="n">ether</span><span class="p">.</span><span class="n">myip</span><span class="p">);</span>
<span class="n">ether</span><span class="p">.</span><span class="n">printIp</span><span class="p">(</span><span class="s">"GW:  "</span><span class="p">,</span> <span class="n">ether</span><span class="p">.</span><span class="n">gwip</span><span class="p">);</span>
<span class="n">ether</span><span class="p">.</span><span class="n">printIp</span><span class="p">(</span><span class="s">"DNS: "</span><span class="p">,</span> <span class="n">ether</span><span class="p">.</span><span class="n">dnsip</span><span class="p">);</span></code></pre></figure>

<p>Now that we have the interface up and running we can work on publishing a HTML page to the interface when someone tries to connect to the web server. We’ll be storing our test html page within the Arduino code itself. If you have an <code class="highlighter-rouge">SD card</code> and an <code class="highlighter-rouge">SD adapter</code> on your Arduino you can also tell the microcontroller to serve the page from the SD directory. In my case however I am simply going to build the HTML directly onto the Arduino chip.</p>

<p>Back at the top of your program add the following as a constant char array. It will store your text in the Arduino <code class="highlighter-rouge">program memory</code> (PROGMEM)</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// Define the HTML that will be served
</span><span class="k">const</span> <span class="kt">char</span> <span class="n">page</span><span class="p">[]</span> <span class="n">PROGMEM</span> <span class="o">=</span>
<span class="s">"HTTP/1.0 503 Service Unavailable</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">"Content-Type: text/html</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">"Retry-After: 600</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">"</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">"&lt;html&gt;"</span>
  <span class="s">"&lt;head&gt;&lt;title&gt;"</span>
    <span class="s">"Arduino Webserver Example"</span>
  <span class="s">"&lt;/title&gt;&lt;/head&gt;"</span>
  <span class="s">"&lt;body&gt;"</span>
    <span class="s">"&lt;h3&gt;Congratulations, you can see this page!&lt;/h3&gt;"</span>
    <span class="s">"&lt;p&gt;&lt;em&gt;"</span>
      <span class="s">"Keep learning!&lt;br /&gt;"</span>
      <span class="s">"And have a happy new year"</span>
    <span class="s">"&lt;/em&gt;&lt;/p&gt;"</span>
  <span class="s">"&lt;/body&gt;"</span>
<span class="s">"&lt;/html&gt;"</span>
<span class="p">;</span></code></pre></figure>

<p>The only thing left to do is to setup some code in the <code class="highlighter-rouge">loop()</code> to serve the page whenever someone connects. This is done via the following code block:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">loop</span><span class="p">(){</span>
  <span class="c1">// wait for an incoming TCP packet, but ignore its contents
</span>  <span class="k">if</span> <span class="p">(</span><span class="n">ether</span><span class="p">.</span><span class="n">packetLoop</span><span class="p">(</span><span class="n">ether</span><span class="p">.</span><span class="n">packetReceive</span><span class="p">()))</span> <span class="p">{</span>
    <span class="n">memcpy_P</span><span class="p">(</span><span class="n">ether</span><span class="p">.</span><span class="n">tcpOffset</span><span class="p">(),</span> <span class="n">page</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">page</span><span class="p">);</span>
    <span class="n">ether</span><span class="p">.</span><span class="n">httpServerReply</span><span class="p">(</span><span class="k">sizeof</span> <span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Lets explore what each of the functions in the loop() block do:</p>

<ul>
  <li><code class="highlighter-rouge">packetLoop()</code> - Waits for and accepts a TCP/IP connection from the Ethernet interface. In this case the <code class="highlighter-rouge">packetReceive()</code> function is the parameter this function takes.</li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">uint16_t</span> <span class="n">packetLoop</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="n">plen</span><span class="p">);</span>

<span class="cm">/**   @brief  Accept a TCP/IP connection
*     @param  port IP port to accept on - do nothing if wrong port
*     @param  plen Number of bytes in packet
*     @return &lt;i&gt;uint16_t&lt;/i&gt; Offset within packet of TCP payload. Zero for no data.
*/</span></code></pre></figure>

<ul>
  <li><code class="highlighter-rouge">packetReceive()</code> - Defined in the <code class="highlighter-rouge">enc28j60.h</code> file, this function copies the packet data from the Ethernet controllers memory and passes it to the <code class="highlighter-rouge">packetLoop()</code> function</li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">uint16_t</span> <span class="n">packetReceive</span> <span class="p">();</span>

<span class="cm">/**   @brief  Copy data from ENC28J60 memory
*     @param  page Data page of memory
*     @param  data Pointer to buffer to copy data to
*/</span></code></pre></figure>

<ul>
  <li><code class="highlighter-rouge">memcpy_P</code> - Takes three arguments:
    <ol>
      <li><code class="highlighter-rouge">destination</code> - ether.tcpOffset() will receive our bytes</li>
      <li><code class="highlighter-rouge">source</code> - The declared page array we declared and stored in PROGMEM</li>
      <li><code class="highlighter-rouge">num</code> - The number of bytes we want to copy to destination, in this case it’s the <code class="highlighter-rouge">sizeof</code> (returns size in bytes) the <code class="highlighter-rouge">page array</code></li>
    </ol>
  </li>
  <li><code class="highlighter-rouge">tcpOffset()</code> - Initializes the SPI interface and serves as a input for the TCP payload</li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="nf">tcpOffset</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">buffer</span> <span class="o">+</span> <span class="mh">0x36</span><span class="p">;</span> <span class="p">}</span> <span class="c1">//!&lt; Pointer to the start of TCP payload
</span>
<span class="cm">/**   @brief  Initialise SPI interface
*     @note   Configures Arduino pins as input / output, etc.
*/</span></code></pre></figure>

<ul>
  <li><code class="highlighter-rouge">httpServerReply()</code> - advises the interface of how many bytes make up the TCP payload. In this case it’s the byte size of the page array minus 1</li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="n">httpServerReply</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="n">dlen</span><span class="p">);</span>

<span class="cm">/**   @brief  Send a response to a HTTP request
*     @param  dlen Size of the HTTP (TCP) payload
*     @param  flags TCP flags
*/</span></code></pre></figure>

<p>And that is it!, if you run your code and navigate to the IP address either set statically or assigned to you via DHCP in a web browser, you should be greeted with the HTML page you defined in the page array.</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html">Congratulations, you can see this page!

Keep learning!
And have a happy new year</code></pre></figure>

<h2 id="conclusion">Conclusion</h2>

<p>That was fun! Difficult, but very fun once I’d found the datasheet for the Ethernet controller. Something I’ve noticed is that I’ve become a lot better at tracking down information myself instead of relying on other peoples description to explain things to me. I think it’s important to do things like what I did in this post; instead of relying on something else’s knowledge to solve a problem, try to understand why everything happens rather than simply accepting that it does.</p>

<p>Below is a full copy of the code I used during the implementation. Also be sure to check the <a href="https://github.com/jcw/ethercard/blob/master/EtherCard.h">github link</a> and have a browse of the libraries that come with EtherCard.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;EtherCard.h&gt;
</span>
<span class="c1">// Ethernet interface ip address
</span><span class="k">static</span> <span class="n">byte</span> <span class="n">myip</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">192</span><span class="p">,</span><span class="mi">168</span><span class="p">,</span><span class="mi">188</span><span class="p">,</span><span class="mi">200</span> <span class="p">};</span>
<span class="c1">// Gateway ip address
</span><span class="k">static</span> <span class="n">byte</span> <span class="n">gwip</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">192</span><span class="p">,</span><span class="mi">168</span><span class="p">,</span><span class="mi">188</span><span class="p">,</span><span class="mi">254</span> <span class="p">};</span>
<span class="c1">// DNS ip address
</span><span class="k">static</span> <span class="n">byte</span> <span class="n">dnsip</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">192</span><span class="p">,</span><span class="mi">168</span><span class="p">,</span><span class="mi">188</span><span class="p">,</span><span class="mi">254</span> <span class="p">};</span>
<span class="c1">// Subnet mask
</span><span class="k">static</span> <span class="n">byte</span> <span class="n">mask</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span> <span class="p">};</span>

<span class="c1">// Ethernet mac address - must be unique on your network
</span><span class="k">static</span> <span class="n">byte</span> <span class="n">mymac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x74</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="mh">0x2D</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="mh">0x31</span> <span class="p">};</span>

<span class="c1">// TCP/IP send and receive buffer
</span><span class="n">byte</span> <span class="n">Ethernet</span><span class="o">::</span><span class="n">buffer</span><span class="p">[</span><span class="mi">500</span><span class="p">];</span>

<span class="c1">// Define the HTML that will be served
</span><span class="k">const</span> <span class="kt">char</span> <span class="n">page</span><span class="p">[]</span> <span class="n">PROGMEM</span> <span class="o">=</span>
<span class="s">"HTTP/1.0 503 Service Unavailable</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">"Content-Type: text/html</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">"Retry-After: 600</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">"</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">"&lt;html&gt;"</span>
  <span class="s">"&lt;head&gt;&lt;title&gt;"</span>
    <span class="s">"Arduino Webserver Example"</span>
  <span class="s">"&lt;/title&gt;&lt;/head&gt;"</span>
  <span class="s">"&lt;body&gt;"</span>
    <span class="s">"&lt;h3&gt;Congratulations, you can see this page!&lt;/h3&gt;"</span>
    <span class="s">"&lt;p&gt;&lt;em&gt;"</span>
      <span class="s">"Keep learning!&lt;br /&gt;"</span>
      <span class="s">"And have a happy new year"</span>
    <span class="s">"&lt;/em&gt;&lt;/p&gt;"</span>
  <span class="s">"&lt;/body&gt;"</span>
<span class="s">"&lt;/html&gt;"</span>
<span class="p">;</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Open a serial connection for debugging
</span>  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">57600</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[Debugger]"</span><span class="p">);</span>

  <span class="c1">// Initialize the Ethernet interface
</span>  <span class="k">if</span> <span class="p">(</span><span class="n">ether</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="k">sizeof</span> <span class="n">Ethernet</span><span class="o">::</span><span class="n">buffer</span><span class="p">,</span> <span class="n">mymac</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span> <span class="s">"Failed to access Ethernet controller"</span><span class="p">);</span>

  <span class="c1">// Setup IP statically
</span>  <span class="n">ether</span><span class="p">.</span><span class="n">staticSetup</span><span class="p">(</span><span class="n">myip</span><span class="p">,</span> <span class="n">gwip</span><span class="p">,</span> <span class="n">dnsip</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

  <span class="c1">// Print IP information out to serial line
</span>  <span class="n">ether</span><span class="p">.</span><span class="n">printIp</span><span class="p">(</span><span class="s">"IP:  "</span><span class="p">,</span> <span class="n">ether</span><span class="p">.</span><span class="n">myip</span><span class="p">);</span>
  <span class="n">ether</span><span class="p">.</span><span class="n">printIp</span><span class="p">(</span><span class="s">"GW:  "</span><span class="p">,</span> <span class="n">ether</span><span class="p">.</span><span class="n">gwip</span><span class="p">);</span>  
  <span class="n">ether</span><span class="p">.</span><span class="n">printIp</span><span class="p">(</span><span class="s">"DNS: "</span><span class="p">,</span> <span class="n">ether</span><span class="p">.</span><span class="n">dnsip</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">(){</span>
  <span class="c1">// wait for an incoming TCP packet, but ignore its contents
</span>  <span class="k">if</span> <span class="p">(</span><span class="n">ether</span><span class="p">.</span><span class="n">packetLoop</span><span class="p">(</span><span class="n">ether</span><span class="p">.</span><span class="n">packetReceive</span><span class="p">()))</span> <span class="p">{</span>
    <span class="n">memcpy_P</span><span class="p">(</span><span class="n">ether</span><span class="p">.</span><span class="n">tcpOffset</span><span class="p">(),</span> <span class="n">page</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">page</span><span class="p">);</span>
    <span class="n">ether</span><span class="p">.</span><span class="n">httpServerReply</span><span class="p">(</span><span class="k">sizeof</span> <span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>


              </div>
              

<!-- Social Button HTML -->
<div class="fa fa-share-bar">
<h4 class="fa fa-share-alt section-title">Share Post :</h4>

<!-- Twitter -->
<a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Arduino Projects - Ethernet using a ENC28J60 Ethernet Controller" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
  <i class="fa fa-twitter fa-lg"></i>
  Twitter
</a>

<!-- Google Plus -->
<a class="btn btn-default btn-sm gplus" onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
  <i class="fa fa-google-plus fa-lg"></i>
  Google+
</a>

<!-- Facebook -->
<a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
  <i class="fa fa-facebook fa-lg"></i>
  Facebook
</a>

<!-- StumbleUpon (url, title) -->
<!--
<a class="btn btn-default btn-sm StumbleUpon" href="http://www.stumbleupon.com/submit?url=http://t04glovern.github.io/2015/12/arduino-projects-ethernet-using-enc28j60&title=Arduino Projects - Ethernet using a ENC28J60 Ethernet Controller" target="_blank" class="share-btn stumbleupon">
  <i class="fa fa-stumbleupon fa-lg"></i>
  StumbleUpon
</a>
-->

<!-- Reddit (url, title) -->
<a class="btn btn-default btn-sm reddit" href="http://reddit.com/submit?url=http://t04glovern.github.io/2015/12/arduino-projects-ethernet-using-enc28j60&title=Arduino Projects - Ethernet using a ENC28J60 Ethernet Controller" target="_blank" class="share-btn reddit">
  <i class="fa fa-reddit fa-lg"></i>
  Reddit
</a>

<!-- LinkedIn -->
<a class="btn btn-default btn-sm linkedin" href="http://www.linkedin.com/shareArticle?mini=true&url=http://t04glovern.github.io/2015/12/arduino-projects-ethernet-using-enc28j60&title=Arduino Projects - Ethernet using a ENC28J60 Ethernet Controller&source=">
  <i class="fa fa-linkedin fa-lg"></i>
  LinkedIn
</a>

<!-- Email -->
<!--
<a class="btn btn-default btn-sm email" href="mailto:?subject=<SUBJECT&body=<BODY>" target="_blank" class="share-btn email">
  <i class="fa fa-envelope"></i>
  Email
</a>
-->
</div><p></p>



              

<section class="site-author1 col-sm-2">
  <br>
  <img src="http://www.gravatar.com/avatar/3f588f12eca6a2e82161a1da2451fe89" class="img-rounded author-image" />
</section>

<section class="site-author2 col-sm-10">
<h4 class="section-title author-name"></h4>
<p class="author-bio">Nathan Glover is a passionate technology enthusiast with a strong
understanding of Windows Server 2012 / Hyper-V and Windows Operating
system support. He has an eagerness to learn new things and generally
spends most of his freetime building up his brain with different concepts.
</p>
</section>



              
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
              </div>
              
            </div>
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  
    <h1>Related By Tags</h1>
  
  <ul>
    
    
      
      
        
          
        
          
        
      
        
          
        
          
        
      
    
      
      
        
          
            <li><a href="http://t04glovern.github.io/2015/12/arduino-project-lcd-displays">Arduino Projects - LCD Displays</a></li>
            
          
        
          
        
      
        
          
        
          
        
      
        
          
        
          
        
      
    
      
      
        
          
            <li><a href="http://t04glovern.github.io/2015/12/arduino-projects-thumbstick-to-rgb-led">Arduino Projects - Thumbstick to RGB LED</a></li>
            
          
        
          
        
      
        
          
        
          
        
      
    
      
      
        
          
            <li><a href="http://t04glovern.github.io/2015/12/arduino-projects-working-with-sound">Arduino Projects - Working with Sound</a></li>
            
          
        
          
        
      
        
          
        
          
        
      
        
          
        
          
        
      
    
      
      
        
          
        
          
        
      
        
          
        
          
        
      
    
      
      
        
          
        
          
        
      
        
          
        
          
        
      
        
          
        
          
        
      
    
      
      
        
          
        
          
        
      
        
          
        
          
        
      
        
          
        
          
        
      
    
      
      
        
          
        
          
        
      
        
          
        
          
        
      
    
      
      
        
          
        
          
        
      
        
          
        
          
        
      
        
          
        
          
        
      
        
          
        
          
        
      
    
  </ul>
</div>

<div class="sidebar">
  <h1>Tags</h1>
  <ul>
     
      <li><a href="/tag/arduino">arduino</a></li>
    
      <li><a href="/tag/asp.net">asp.net</a></li>
    
      <li><a href="/tag/bash">bash</a></li>
    
      <li><a href="/tag/electronics">electronics</a></li>
    
      <li><a href="/tag/ethernet">ethernet</a></li>
    
      <li><a href="/tag/grief">grief</a></li>
    
      <li><a href="/tag/internet">internet</a></li>
    
      <li><a href="/tag/lcd">lcd</a></li>
    
      <li><a href="/tag/node.js">node.js</a></li>
    
      <li><a href="/tag/script">script</a></li>
    
      <li><a href="/tag/sound">sound</a></li>
    
      <li><a href="/tag/visualstudio">visualstudio</a></li>
    
      <li><a href="/tag/vscode">vscode</a></li>
    
      <li><a href="/tag/windows">windows</a></li>
    
      <li><a href="/tag/yeoman">yeoman</a></li>
    
  </ul>
</div>

        </div>
      </div>
    </div>
    
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = "t04glovern"; // required: replace example with your forum shortname
  var disqus_identifier = "/2015/12/arduino-projects-ethernet-using-enc28j60";
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  </div>
      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Nathan Glover &copy; 2015</p>
          <h6>Follow me</h6>

<ul class="social-media">

    
    <li>
        <a title="t04glovern on Github"
            href="https://github.com/t04glovern"
            target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
    

    
    <li>
        <a title="5443325 on StackOverflow"
            href="http://stackoverflow.com/users/5443325"
            target="_blank"><i class="fa fa-stack-overflow fa-2x"></i></a>
    </li>
    

    
    <li>
        <a title="t04glovern on LinkedIn"
            href="https://www.linkedin.com/in/glovernathan"
            target="_blank"><i class="fa fa-linkedin fa-2x"></i></a>
    </li>
    


    
    <li>
        <a title="nathanglove on Instagram"
            href="https://instagram.com/nathanglove"
            target="_blank"><i class="fa fa-instagram fa-2x"></i></a>
    </li>
    


    
    <li>
        <a title="t04glovern on LastFm"
            href="http://lastfm.com/user/t04glovern"
            target="_blank"><i class="fa fa-lastfm fa-2x"></i></a>
    </li>
    

    
    <li>
        <a title="feed.xml RSS"
            href="http://t04glovern.github.io/feed.xml"
            target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
    

</ul>

        </div>
      </div>
    </footer>
  </body>
</html>

</div>
